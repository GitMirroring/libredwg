{"version":1,"ops":[{"type":1,"author":{"id":"adf43da3a2a0f02dbfb5a8bdfc874e2af71e656d"},"timestamp":1562177114,"metadata":{"github-id":"MDU6SXNzdWU0NjM4ODYzOTc=","github-url":"https://github.com/LibreDWG/libredwg/issues/112","origin":"github"},"title":"Incorrect object address set","message":"It looks like setting 'obj-\u003eaddress' is wrong for R_2010+ files. The data read for 'handlestream_size' in R_2010+ files should not be counted in the object size.\n\nCurrently in decode.c:\n\n  obj-\u003eaddress = dat-\u003ebyte;\n  end_address = obj-\u003eaddress + obj-\u003esize; /* (calculate the bitsize) */\n  SINCE (R_2010)\n  {\n    obj-\u003ehandlestream_size = bit_read_UMC (dat);\n    LOG_INFO (\", Hdlsize: \" FORMAT_UMC, obj-\u003ehandlestream_size);\n    obj-\u003ebitsize = obj-\u003esize * 8 - obj-\u003ehandlestream_size;\n    obj-\u003etype = bit_read_BOT (dat);\n  }\n  else { obj-\u003etype = bit_read_BS (dat); }\n\n\nShould be changed to:\n\n  SINCE (R_2010)\n  {\n    /* This is not counted in the object size */\n    obj-\u003ehandlestream_size = bit_read_UMC (dat);\n    LOG_INFO (\", Hdlsize: \" FORMAT_UMC, obj-\u003ehandlestream_size);\n    obj-\u003ebitsize = obj-\u003esize * 8 - obj-\u003ehandlestream_size;\n  }\n  \n  obj-\u003eaddress = dat-\u003ebyte;\n  end_address = obj-\u003eaddress + obj-\u003esize; /* (calculate the bitsize) */\n\n  SINCE (R_2010)\n  {\n    obj-\u003etype = bit_read_BOT (dat);\n  }\n  else { obj-\u003etype = bit_read_BS (dat); }\n\n\nThis however has further knock on effects. It looks like some pieces of code have been modified in order to 'fix' the error.\n\n1) The setting of 'obj-\u003ehdlpos' and 'obj-\u003ehandle_offset' should no longer have '+= 8' in functions dwg_decode_entity() and dwg_decode_object(). (it has already been tagged 'FIXME')\n\n2) The reading of BLOCK_CONTROL in dwg.spec should remove the 'UNTIL (R_2007)'. The paper_space block can always be read.\n    I.e., change\n    \n      UNTIL (R_2007) {\n        FIELD_HANDLE (paper_space, 3, 0);\n      }\n  \n    to\n  \n      FIELD_HANDLE (paper_space, 3, 0);\n\n3) There may be more....","files":null}]}