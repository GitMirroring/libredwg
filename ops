{"version":1,"ops":[{"type":1,"author":{"id":"81d2bca124c3dd496b9ee893f66bd18aae086620"},"timestamp":1532129193,"metadata":{"github-id":"MDU6SXNzdWUzNDMyNzQwMTU=","github-url":"https://github.com/LibreDWG/libredwg/issues/33","origin":"github"},"title":"double free in dwg_free","message":"When open the crafted  `dwg` file , it could tigger `double free` in `dwg2svg2`\n\nLet's see the program error output \n\n```\n15:20 haclh@ubuntu:examples $ ./dwg2svg2 dfree_poc_155 \n......................................................................\n......................................................................\n......................................................................\n=================================================================\n*** Error in `./dwg2svg2': double free or corruption (fasttop): 0x0000000001336430 ***\n======= Backtrace: =========\n/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7f18b82547e5]\n/lib/x86_64-linux-gnu/libc.so.6(+0x8037a)[0x7f18b825d37a]\n/lib/x86_64-linux-gnu/libc.so.6(cfree+0x4c)[0x7f18b826153c]\n./dwg2svg2[0x499e0b]\n./dwg2svg2[0x49a31a]\n./dwg2svg2[0x4a18e9]\n./dwg2svg2[0x4a239d]\n./dwg2svg2[0x40d13f]\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7f18b81fd830]\n./dwg2svg2[0x40d3a9]\n======= Memory map: ========\n00400000-00569000 r-xp 00000000 08:10 1140093                            /home/haclh/vmdk/fuzz_workplace/libredwg-0.5.1048/examples/dwg2svg2\n00768000-00769000 r--p 00168000 08:10 1140093                            /home/haclh/vmdk/fuzz_workplace/libredwg-0.5.1048/examples/dwg2svg2\n00769000-0076a000 rw-p 00169000 08:10 1140093                            /home/haclh/vmdk/fuzz_workplace/libredwg-0.5.1048/examples/dwg2svg2\n0076a000-0076c000 rw-p 00000000 00:00 0 \n01319000-0135b000 rw-p 00000000 00:00 0                                  [heap]\n7f18b3dea000-7f18b3e00000 r-xp 00000000 08:01 1315919                    /lib/x86_64-linux-gnu/libgcc_s.so.1\n7f18b3e00000-7f18b3fff000 ---p 00016000 08:01 1315919                    /lib/x86_64-linux-gnu/libgcc_s.so.1\n7f18b3fff000-7f18b4000000 rw-p 00015000 08:01 1315919                    /lib/x86_64-linux-gnu/libgcc_s.so.1\n7f18b4000000-7f18b4021000 rw-p 00000000 00:00 0 \n7f18b4021000-7f18b8000000 ---p 00000000 00:00 0 \n7f18b81dd000-7f18b839d000 r-xp 00000000 08:01 1366856                    /lib/x86_64-linux-gnu/libc-2.23.so\n7f18b839d000-7f18b859d000 ---p 001c0000 08:01 1366856                    /lib/x86_64-linux-gnu/libc-2.23.so\n7f18b859d000-7f18b85a1000 r--p 001c0000 08:01 1366856                    /lib/x86_64-linux-gnu/libc-2.23.so\n7f18b85a1000-7f18b85a3000 rw-p 001c4000 08:01 1366856                    /lib/x86_64-linux-gnu/libc-2.23.so\n7f18b85a3000-7f18b85a7000 rw-p 00000000 00:00 0 \n7f18b85a7000-7f18b86af000 r-xp 00000000 08:01 1315583                    /lib/x86_64-linux-gnu/libm-2.23.so\n7f18b86af000-7f18b88ae000 ---p 00108000 08:01 1315583                    /lib/x86_64-linux-gnu/libm-2.23.so\n7f18b88ae000-7f18b88af000 r--p 00107000 08:01 1315583                    /lib/x86_64-linux-gnu/libm-2.23.so\n7f18b88af000-7f18b88b0000 rw-p 00108000 08:01 1315583                    /lib/x86_64-linux-gnu/libm-2.23.so\n7f18b88b0000-7f18b88d6000 r-xp 00000000 08:01 1366854                    /lib/x86_64-linux-gnu/ld-2.23.so\n7f18b8aaf000-7f18b8ab3000 rw-p 00000000 00:00 0 \n7f18b8ad4000-7f18b8ad5000 rw-p 00000000 00:00 0 \n7f18b8ad5000-7f18b8ad6000 r--p 00025000 08:01 1366854                    /lib/x86_64-linux-gnu/ld-2.23.so\n7f18b8ad6000-7f18b8ad7000 rw-p 00026000 08:01 1366854                    /lib/x86_64-linux-gnu/ld-2.23.so\n7f18b8ad7000-7f18b8ad8000 rw-p 00000000 00:00 0 \n7fff6f0da000-7fff6f0fb000 rw-p 00000000 00:00 0                          [stack]\n7fff6f127000-7fff6f12a000 r--p 00000000 00:00 0                          [vvar]\n7fff6f12a000-7fff6f12c000 r-xp 00000000 00:00 0                          [vdso]\nffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]\nAborted\n\n```\n\nAnd the output with **asan**\n\n```\n15:20 haclh@ubuntu:examples $ ./dwg2svg2 dfree_poc_155 \n......................................................................\n......................................................................\n......................................................................\n=================================================================\n==101914==ERROR: AddressSanitizer: attempting double-free on 0x60400000dbd0 in thread T0:\n    #0 0x7f9dcd3e32ca in __interceptor_free (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x982ca)\n    #1 0x642d83 in dwg_free_eed /home/haclh/workplace/libredwg-0.5.1048/src/free.c:283\n    #2 0x6513db in dwg_free_UNKNOWN_OBJ /home/haclh/workplace/libredwg-0.5.1048/src/dwg.spec:5437\n    #3 0x6513db in dwg_free_BLOCK_HEADER /home/haclh/workplace/libredwg-0.5.1048/src/dwg.spec:2177\n    #4 0x664f98 in dwg_free_object /home/haclh/workplace/libredwg-0.5.1048/src/free.c:471\n    #5 0x667d2a in dwg_free /home/haclh/workplace/libredwg-0.5.1048/src/free.c:640\n    #6 0x42d81d in test_SVG /home/haclh/workplace/libredwg-0.5.1048/examples/dwg2svg2.c:92\n    #7 0x42d81d in main /home/haclh/workplace/libredwg-0.5.1048/examples/dwg2svg2.c:482\n    #8 0x7f9dccfa182f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2082f)\n    #9 0x42de88 in _start (/home/haclh/workplace/libredwg-0.5.1048/examples/dwg2svg2+0x42de88)\n\n0x60400000dbd0 is located 0 bytes inside of 40-byte region [0x60400000dbd0,0x60400000dbf8)\nfreed by thread T0 here:\n    #0 0x7f9dcd3e32ca in __interceptor_free (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x982ca)\n    #1 0x47ee9f in dwg_decode_eed /home/haclh/workplace/libredwg-0.5.1048/src/decode.c:2311\n\npreviously allocated by thread T0 here:\n    #0 0x7f9dcd3e379a in __interceptor_calloc (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x9879a)\n    #1 0x47e349 in dwg_decode_eed /home/haclh/workplace/libredwg-0.5.1048/src/decode.c:2304\n\nSUMMARY: AddressSanitizer: double-free ??:0 __interceptor_free\n==101914==ABORTING\n\n```\n\nAccording **debuging**,  I found that When open the crafted  `dwg` file ,  `dwg_free` could call `dwg_decode_eed` , in `dwg_free_object`  first,  it could call `dwg_free_BLOCK_HEADER` to free a pointer (for example : `0x789430` )\n\n```\nvoid\ndwg_free_object(Dwg_Object *obj)\n{\n  switch (obj-\u003etype)\n    {\n    case DWG_TYPE_TEXT:\n    ........................\n    ........................\n    ........................\n    case DWG_TYPE_BLOCK_HEADER:\n      dwg_free_BLOCK_HEADER(dat, obj);\n      break;\n\n```\n\nThe backtrace are as below\n\n```\n   f 0     7ffff77884f0 free\n â–º f 1           49a1c4 dwg_free_BLOCK_HEADER.isra.7+68\n   f 2           4a18e9 dwg_free_object+1161\n   f 3           4a239d dwg_free+157\n   f 4           40d13f main+575\n   f 5           40d13f main+575\n   f 6     7ffff7724830 __libc_start_main+240\n```\n\n\n\nAnd then it could call `dwg_free_BLOCK_HEADER` again , it could call `dwg_free_eed` to free `0x789430`  again.\n\nThe backtrace are as below\n\n```\npwndbg\u003e bt\n#0  __GI___libc_free (mem=0x789430) at malloc.c:2934\n#1  0x0000000000499e0b in dwg_free_eed (obj=0x7988e8, obj=0x7988e8) at free.c:283\n#2  0x000000000049a31a in dwg_free_BLOCK_HEADER (obj=0x7988e8, _dat=\u003coptimized out\u003e) at dwg.spec:2285\n#3  0x00000000004a18e9 in dwg_free_object (obj=0x7988e8) at free.c:471\n#4  0x00000000004a239d in dwg_free (dwg=dwg@entry=0x769400 \u003cg_dwg\u003e) at free.c:640\n#5  0x000000000040d13f in test_SVG (filename=\u003coptimized out\u003e) at dwg2svg2.c:92\n#6  main (argc=argc@entry=2, argv=argv@entry=0x7fffffffe4c8) at dwg2svg2.c:479\n#7  0x00007ffff7724830 in __libc_start_main (main=0x40cf00 \u003cmain\u003e, argc=2, argv=0x7fffffffe4c8, init=\u003coptimized out\u003e, fini=\u003coptimized out\u003e, rtld_fini=\u003coptimized out\u003e, stack_end=0x7fffffffe4b8) at ../csu/libc-start.c:291\n#8  0x000000000040d3a9 in _start ()\n\n```\n\n\n\nThe poc file\n\n```\nhttps://gitee.com/hac425/fuzz_data/blob/master/double_free_on_libredwg_155\n```","files":null}]}