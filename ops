{"version":1,"ops":[{"type":6,"author":{"id":"adf43da3a2a0f02dbfb5a8bdfc874e2af71e656d"},"timestamp":1562319134,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDI0NTM5OTY4NA=="},"target":"b02bea32c03370ebb10af21411a27871b493e82b95afbd2b42aad0931f8c513c","message":"Hi,\n\nThe FIELDLIST object does not correctly decode it's field handles because there is an owerhandle, reactors and xdic handle read missing.\n\nThe following:\n  START_HANDLE_STREAM;\n  HANDLE_VECTOR (field_handles, num_fields, 0, 330); // 2 or 4, or 3.0.0\n\nneeds to change to (need to add ownerhandle to dwg_object_FIELDLIST \nstructure):\n  START_HANDLE_STREAM;\n  FIELD_HANDLE (ownerhandle, 4, 0);\n  REACTORS(4);\n  XDICOBJHANDLE(3);\n  HANDLE_VECTOR (field_handles, num_fields, 0, 330); // 2 or 4, or 3.0.0\n\nLooking at the dwg.spec it seems to me that EVERY object should have:\n\n  START_HANDLE_STREAM;\n  FIELD_HANDLE (ownerhandle, 4, 0);\n  REACTORS(4);\n  XDICOBJHANDLE(3);\n  // Further object handles start here\n\nbefore reading any other objects. Every object currently reads \u003cnum_reactors\u003e and \u003cxdic_missing_flag\u003e so that says to me that these handles may exist at the start of the handles stream. I have tested this with several objects:\n\nFIELD            - Already in issue #117 \nFIELDLIST\nMLEADERSTYLE - This needs the change I have suggested above\n\nA quick search through dwg.spec for \"START_HANDLE_STREAM\" showed many inconsistencies. \nFor example, BLOCK_CONTROL (indeed all '_CONTROL' objects) had a missing REACTORS(4). Several other objects (such as TABLECONTENT) would start reading private object handles immediately after the START_HANDLE_STREAM.\n\nI propose that a new macro is created called \"START_OBJECT_HANDLE_STREAM\" which simply expands to \n  START_HANDLE_STREAM;\n  FIELD_HANDLE (ownerhandle, 4, 0);\n  REACTORS(4);\n  XDICOBJHANDLE(3);\n\nand that all objects call this instead of just START_HANDLE_STREAM; \n\nBelow is the extract from the ODA spec for what is at the end of every object:\n\nCommon\nBelow begins the handles stream, this begins at offset specified by number of bits before handles above\nH     Parent handle (soft pointer)\nH     [Reactors (soft pointer)], repeated as many times as specified by the number of persistent reactors\nH     xdictionary (hard owner), present if the has xdictionary flag is true\nX     Object specific handles\nB*    Padding bits are added until the next byte boundary is reached.\nRS   CRC\nThe CRC includes the size bytes.","files":null},{"type":3,"author":{"id":"b57a4f5420adf835b8b83469143e813bd4f12c78"},"timestamp":1562349409,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUwODgyNzkyMA==","github-url":"https://github.com/LibreDWG/libredwg/issues/118#issuecomment-508827920"},"message":"START_OBJECT_HANDLE_STREAM sounds good, yes.\nI'll start with your proposals next week. Maybe we can generalize it that easily","files":null},{"type":5,"author":{"id":"b57a4f5420adf835b8b83469143e813bd4f12c78"},"timestamp":1562432370,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDI0NjQwMjMwMzM="},"added":["bug"],"removed":[]},{"type":3,"author":{"id":"b57a4f5420adf835b8b83469143e813bd4f12c78"},"timestamp":1562523324,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUwOTAxOTk0OQ==","github-url":"https://github.com/LibreDWG/libredwg/issues/118#issuecomment-509019949"},"message":"Fixed these handles, and generalized START_OBJECT_HANDLE_STREAM as described.\nAll objects have now a common ownerhandle in obj-\u003etio.object, analog to reactors and xdicobjhandle.","files":null},{"type":4,"author":{"id":"b57a4f5420adf835b8b83469143e813bd4f12c78"},"timestamp":1562523324,"metadata":{"github-id":"MDExOkNsb3NlZEV2ZW50MjQ2NDUwNDk0Nw=="},"status":2},{"type":3,"author":{"id":"b57a4f5420adf835b8b83469143e813bd4f12c78"},"timestamp":1562525578,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUwOTAyMjM5MQ==","github-url":"https://github.com/LibreDWG/libredwg/issues/118#issuecomment-509022391"},"message":"The following should be done instead:\n\n* setup the handle and string stream before (in dwg_decode_object).\n  this could be limited/sliced in range to the specific object only from the main dat stream, to avoid overflows into a next object, and simplify error handling, which is currently object specific. See #85.\n* read the handle stream at the beginning, before. (in dwg_decode_object).\n  The extra fields as specified can be mixed into the spec, as e.g. in MLINESTYLE, and do not need to be at the very end.\n* then read all the object specific fields as specified in the spec, which does not need the boilerplate\nSTART_OBJECT_HANDLE_STREAM at the end anymore.","files":null}]}