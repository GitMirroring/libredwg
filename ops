{"version":1,"ops":[{"type":1,"author":{"id":"81d2bca124c3dd496b9ee893f66bd18aae086620"},"timestamp":1532096534,"metadata":{"github-id":"MDU6SXNzdWUzNDMxMjY2NjU=","github-url":"https://github.com/LibreDWG/libredwg/issues/32","origin":"github"},"title":"null pointer dereference in dwg_obj_block_control_get_block_headers","message":"When open the crafted  `dwg` file , it could tigger `null point dereference` in `dwg2svg2`\n\nLet's see the gdb output \n\n```\n\nProgram received signal SIGSEGV, Segmentation fault.\n0x00000000005fc91c in dwg_obj_block_control_get_block_headers (ctrl=0xa51e30 \u003cg_dwg+3088\u003e, error=\u003coptimized out\u003e) at dwg_api.c:17897\n17897\t          ptx[i] = ctrl-\u003eblock_headers[i];\nLEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA\n─────────────────────────────────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────────────────────────────────\n*RAX  0x7ffff7f6c800 ◂— 0xbebebebebebebebe\n*RBX  0xa51e30 (g_dwg+3088) —▸ 0x60800000bfa0 ◂— 0x0\n*RCX  0x7ffff7f6c800 ◂— 0xbebebebebebebebe\n RDX  0x0\n RDI  0x0\n RSI  0x0\n R8   0x0\n*R9   0xa51e50 (g_dwg+3120) ◂— 0x0\n*R10  0x14a3ca\n*R11  0x7ffff7f8c818 ◂— 0x0\n*R12  0x7ffff7f6c800 ◂— 0xbebebebebebebebe\n*R13  0x4002\n*R14  0x7fffffffe280 ◂— 0x41b58ab3\n R15  0x0\n*RBP  0x7fffffffe210 —▸ 0x7fffffffe300 —▸ 0x7fffffffe330 —▸ 0x7fffffffe3e0 —▸ 0x71ed30 (__libc_csu_init) ◂— ...\n*RSP  0x7fffffffe1f0 ◂— 0x0\n*RIP  0x5fc91c (dwg_obj_block_control_get_block_headers+217) ◂— mov    rdx, qword ptr [rdx]\n──────────────────────────────────────────────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────────────────────────────────────────────\n ► 0x5fc91c \u003cdwg_obj_block_control_get_block_headers+217\u003e    mov    rdx, qword ptr [rdx]\n   0x5fc91f \u003cdwg_obj_block_control_get_block_headers+220\u003e    mov    rdi, rcx\n   0x5fc922 \u003cdwg_obj_block_control_get_block_headers+223\u003e    mov    r8, rcx\n   0x5fc925 \u003cdwg_obj_block_control_get_block_headers+226\u003e    shr    r8, 3\n   0x5fc929 \u003cdwg_obj_block_control_get_block_headers+230\u003e    cmp    byte ptr [r8 + 0x7fff8000], 0\n   0x5fc931 \u003cdwg_obj_block_control_get_block_headers+238\u003e    je     dwg_obj_block_control_get_block_headers+245 \u003c0x5fc938\u003e\n    ↓\n   0x5fc938 \u003cdwg_obj_block_control_get_block_headers+245\u003e    mov    qword ptr [rcx], rdx\n   0x5fc93b \u003cdwg_obj_block_control_get_block_headers+248\u003e    add    rcx, 8\n   0x5fc93f \u003cdwg_obj_block_control_get_block_headers+252\u003e    cmp    rcx, r11\n   0x5fc942 \u003cdwg_obj_block_control_get_block_headers+255\u003e    jne    dwg_obj_block_control_get_block_headers+164 \u003c0x5fc8e7\u003e\n    ↓\n   0x5fc8e7 \u003cdwg_obj_block_control_get_block_headers+164\u003e    mov    rdx, rcx\n───────────────────────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]───────────────────────────────────────────────────────────────────────────────────────\n   17892     {\n   17893       BITCODE_BS i;\n   17894       *error = 0;\n   17895       for (i=0; i \u003c ctrl-\u003enum_entries; i++)\n   17896         {\n ► 17897           ptx[i] = ctrl-\u003eblock_headers[i];\n   17898         }\n   17899       return ptx;\n   17900     }\n   17901   else\n   17902     {\n───────────────────────────────────────────────────────────────────────────────────────────[\npwndbg\u003e p ptx\n$1 = (dwg_object_ref **) 0x7ffff7f6c800\npwndbg\u003e p ctrl-\u003eblock_headers \n$2 = (Dwg_Object_Ref **) 0x0\npwndbg\u003e bt\n#0  0x00000000005fc91c in dwg_obj_block_control_get_block_headers (ctrl=0xa51e30 \u003cg_dwg+3088\u003e, error=\u003coptimized out\u003e) at dwg_api.c:17897\n#1  0x0000000000403d88 in output_SVG (dwg=0xa51220 \u003cg_dwg\u003e) at dwg2svg2.c:358\n#2  0x0000000000401af9 in test_SVG (filename=0x7fffffffe73a \"segment_poc\") at dwg2svg2.c:90\n#3  0x0000000000404656 in main (argc=2, argv=0x7fffffffe4c8) at dwg2svg2.c:479\n#4  0x00007ffff67b7830 in __libc_start_main (main=0x403fa3 \u003cmain\u003e, argc=2, argv=0x7fffffffe4c8, init=\u003coptimized out\u003e, fini=\u003coptimized out\u003e, rtld_fini=\u003coptimized out\u003e, stack_end=0x7fffffffe4b8) at ../csu/libc-start.c:291\n#5  0x0000000000401919 in _start ()\npwndbg\u003e \n\n```\n\nAs you can see , crash in \n\n```\nptx[i] = ctrl-\u003eblock_headers[i];\n```\n\n\n\nand   `null point dereference` is **0** , so  `null point dereference` 。\n\n\n\nThe Vulnerability is that `dwg_obj_block_control_get_block_headers` in `dwg_api.c`  don't check the `ctrl-\u003eblock_headers` .\n\n```\ndwg_object_ref **\ndwg_obj_block_control_get_block_headers(const dwg_obj_block_control *restrict ctrl,\n                                        int *restrict error)\n{\n  dwg_object_ref **ptx = (dwg_object_ref**)\n    malloc(ctrl-\u003enum_entries * sizeof(Dwg_Object_Ref *));\n  if (ptx)\n    {\n      BITCODE_BS i;\n      *error = 0;\n      for (i=0; i \u003c ctrl-\u003enum_entries; i++)\n        {\n          ptx[i] = ctrl-\u003eblock_headers[i];\n        }\n      return ptx;\n    }\n  else\n    {\n      *error = 1;\n      LOG_ERROR(\"%s: null malloc\", __FUNCTION__)\n      return NULL;\n    }\n}\n```\n\n\n\nTo fix it,  please **verify the  ctrl-\u003eblock_headers** before use it.\n\nThe poc file\n\n```\nhttps://gitee.com/hac425/fuzz_data/blob/master/poc.dwg\n```","files":null}]}